<?php
/**
 * Notice Classs
 *
 * @author {{author_name}}
 * @package {{slug}}
 */

namespace {{namespace}};

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Notice Class
 *
 * @package {{slug}}
 */
class Notice {
	/**
	 * Class constructor.
	 */
	public function __construct() {
		$this->load_hooks();
	}

	/**
	 * Load initial hooks.
	 */
	private function load_hooks() {
		// notice.
		add_action( 'wp_ajax_{{slug}}s_set_admin_notice_viewed', array( $this, 'notice_closed' ) );
		add_action( 'admin_notices', array( $this, 'notice_install_plugin' ) );
		add_action( 'admin_enqueue_scripts', array( $this, 'enqueue_admin_assets' ) );
	}

	/**
	* Enqueue scripts and styles for the admin area.
	*/
	public function enqueue_admin_assets() {
		wp_enqueue_script(
			'base-admin-script',
			trailingslashit( get_template_directory_uri() ) . 'assets/js/notice.js',
			array( 'jquery', 'wp-api' ),
			{{constant}}_VERSION,
			true
		);

				$all_plugin = get_plugins();
		$plugins    = array(
			array(
				'slug' => 'gutenverse-companion',
				'name' => 'Gutenverse Companion',
			),
		);
		$actions    = array();

		foreach ( $plugins as $plugin ) {
			$slug   = $plugin['slug'];
			$path   = "$slug/$slug.php";
			$active = is_plugin_active( $path );

			if ( isset( $all_plugin[ $path ] ) ) {
				if ( $active ) {
					$actions[ $slug ] = 'active';
				} else {
					$actions[ $slug ] = 'inactive';
				}
			} else {
				$actions[ $slug ] = '';
			}
		}

		$localized_data = array(
			'action'  => $actions,
			'nonce'   => wp_create_nonce( 'merdekas_admin_notice' ),
			'plugins' => $plugins,
		);

		wp_localize_script( 'base-admin-script', 'BaseAdminData', $localized_data );

		wp_enqueue_style(
			'base-admin-style',
			trailingslashit( get_template_directory_uri() ) . 'assets/css/notice.css',
			array(),
			{{constant}}_VERSION
		);
	}

	/**
	 * Show notification to install Gutenverse Plugin.
	 */
	public function notice_install_plugin() {
		// Skip if gutenverse block activated.
		if ( defined( 'GUTENVERSE_COMPANION' ) ) {
			return;
		}

		$screen = get_current_screen();
		if ( isset( $screen->parent_file ) && 'themes.php' === $screen->parent_file && 'appearance_page_{{slug}}-dashboard' === $screen->id ) {
			return;
		}

		if ( isset( $screen->parent_file ) && 'plugins.php' === $screen->parent_file && 'update' === $screen->id ) {
			return;
		}

		if ( 'true' === get_user_meta( get_current_user_id(), 'gutenverse_companion_install_notice', true ) ) {
			return;
		}

		$all_plugin = get_plugins();
		$plugins    = array(
			array(
				'slug' => 'gutenverse-companion',
				'name' => 'Gutenverse Companion',
			),
		);
		$actions    = array();

		foreach ( $plugins as $plugin ) {
			$slug   = $plugin['slug'];
			$path   = "$slug/$slug.php";
			$active = is_plugin_active( $path );

			if ( isset( $all_plugin[ $path ] ) ) {
				if ( $active ) {
					$actions[ $slug ] = 'active';
				} else {
					$actions[ $slug ] = 'inactive';
				}
			} else {
				$actions[ $slug ] = '';
			}
		}

		?>
		<div class="notice is-dismissible install-gutenverse-plugin-notice" style="background: url( <?php echo esc_url( trailingslashit( get_template_directory_uri() ) . '/assets/img/background-banner.png' ); ?> );">
				<div class="gutenverse-notice-inner">
					<div class="gutenverse-notice-content">
						<div class="gutenverse-notice-text">
							<h3><?php esc_html_e( 'Install ', '{{slug}}' ); ?> <span>Gutenverse Companion</span> <?php esc_html_e( ' to start exploring prebuild templates.', '{{slug}}' ); ?></h3>
							<p><?php esc_html_e( 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Fusce ac felis orci. Interdum et malesuada fames ac ante ipsum primis in faucibus. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos.', '{{slug}}' ); ?></p>
							<div class="gutenverse-bottom">
								<a class="gutenverse-button" id="gutenverse-install-companion">
									<?php echo esc_html( __( 'Install Gutenverse Companion', '{{slug}}' ) ); ?>
								</a>
							</div>
						</div>
						<div class="gutenverse-notice-image">
							<img src="<?php echo esc_url( trailingslashit( get_template_directory_uri() ) . '/assets/img/banner-install-gutenverse-2.png' ); ?>"/>
						</div>
					</div>
				</div>
			</div>
		<?php
	}

	/**
	 * Notice Closed
	 */
	public function notice_closed() {
		if ( isset( $_POST['nonce'] ) && wp_verify_nonce( sanitize_text_field( wp_unslash( $_POST['nonce'] ) ), '{{slug}}s_admin_notice' ) ) {
			update_user_meta( get_current_user_id(), 'gutenverse_companion_install_notice', 'true' );
		}
		die;
	}
}
